/*
/////ВТИ-СЕРВИС, 2017//////
г. Курск, ул. Ватутина, 25
---------------------------
версия 5.1.0.0
---------------------------
Скрипт предназначен для обмена с дисконтным сервером для FRONTOL.


*/


function init()
{
 frontol.addEventListener("addCard", "getCardBonus", true);
 frontol.addEventListener("closeDocument", "beforeClose", true);
 frontol.addEventListener("closeDocument", "afterClose", false);

}

var DISCOUNT_PLAN = null;
var discount = 0;
var bonus = 0;
var payValue = 0;
var card_code = 0;
var max_bonus_percentage = 100;

//Настройки скрипта
var ACCESS_KEY = "695a6bb51078e5a5d64a3e6aa87bb7fad6ef5e310a218bcff6dd68590bf1c2f4";
var SERVER = "http://192.168.0.202/";


// Эту функцию следует указать в маркетинговой акции в качестве функции вычисления процентной скидки
function addDiscountPay()
{
  return discount;
}


// Эту функцию следует указать в маркетинговой акции в качестве функции вычисления рублевой скидки (бонусов)
function addBonusPay()
{
  var bonus_current;
  var doc_sum = frontol.currentDocument.totalSum;
  var bonus_limit = doc_sum * max_bonus_percentage / 100;
  if (bonus_limit >= bonus)
  {
     bonus_current = bonus;
  } else
  {
    bonus_current = bonus_limit;
  }

  if (bonus_current == 0)
  {
     return null;
  }


 if ( frontol.actions.showMessage("Вы можете оплатить бонусами " + bonus_current + ". Списать бонусы?", Button.YesNo, Icon.Question) == DialogResult.Yes)
 {
      payValue = frontol.actions.inputString("Введите сумму списания бонусов. Максимально: " + bonus_current, bonus_current, 10);
      if (payValue == null)
      {
       return null;
      }  else if  (parseFloat(payValue) > bonus_current)
      {
            frontol.actions.showMessage("Сумма списания превышает возможную сумму. Отмена скидок!");
            return null;
      }
      bonus = bonus - payValue;
      return parseFloat(payValue);


 } else
 {
   return null;
   }
}





function beforeClose()
{
  frontol.currentDocument.recalculateAllDiscounts();
         //Списываем бонусы
     if (payValue > 0 )
     {
      if (remCardBonus(payValue) == payValue)   // если списались
         {
          return parseFloat(payValue);
           }
            else       // если не списались
            {
             frontol.actions.showError("Невозможно списать бонусы!");
             frontol.currentDocument.recalculateAllDiscounts();
              return null;
               }
       }
}


function afterClose()
{
      if ( ! addCardAccum(frontol.currentDocument.totalSum)) {
          frontol.actions.showError("Невозможно добавить накопления на карту!");
      };
}


function getDiscountPlan()
{
     var xhr = new ActiveXObject("MSXML2.XMLHTTP");
     var salt = Math.random();
     xhr.open("POST", SERVER+"api/get_plan/"+ salt+"/", true);
     xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
     var data = "key=" + ACCESS_KEY;
     xhr.send(data);
     var plan = '';
     while(xhr.readyState != 4){
        frontol.actions.wait("Идет запрос к дисконтному серверу", 1);
     }
     if(xhr.status === 200) {
        try{
            plan = xhr.responseText;
            if (plan == 'discount')
            {
               DISCOUNT_PLAN = plan
               return true;
            }  else if (plan == 'bonus')
            {
               DISCOUNT_PLAN = plan
               return true;
             }  else if (plan == 'combo')
            {
               DISCOUNT_PLAN = plan
               return true;
             }
             else
             {
                 frontol.actions.showError("Дисконтная программа не найдена");
                 return false;
            }
        }
        catch(e){
            frontol.actions.showError(e);
            return null;
        }
     }
     else if(xhr.status === 404)
     {
          frontol.actions.showError("Дисконтная программа не найдена!");
          return false;
     }
      else if(xhr.status === 503)
     {
          frontol.actions.showError("Проверьте параметры доступа и действие подписки");
          return false;
     }
     else
     {
        frontol.actions.showError("Ошибка получения данных с дисконтного сервиса");
        return false;
     }
}



function getCardBonus(Card)
{
      card_code = Card.value;

      if (frontol.currentDocument.cardValues != "")
      {
          frontol.actions.showError("Карта клиента уже введена! Воспользуйтесь кнопкой отмены введенных карт.");
          return null;
      }
      if (! getDiscountPlan())
      {
             return null;
      }

      payValue=0;
      bonus=0;
      discount=0;
      var xhr = new ActiveXObject("MSXML2.XMLHTTP");
      var salt = Math.random();
     xhr.open("POST", SERVER+"api/cards/"+DISCOUNT_PLAN+"/"+card_code+"_" + salt+"/", true);
     xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
     var data = "key=" + ACCESS_KEY;
     xhr.send(data);
     var Disc = 0;
     while(xhr.readyState != 4){
        frontol.actions.wait("Идет запрос к дисконтному серверу", 1);
     }
     if(xhr.status === 200) {
        try{
            Disc = xhr.responseText;
            if (DISCOUNT_PLAN == 'bonus')
                {
                frontol.actions.showMessage("Накопления на карте: "+Disc);
                 bonus = parseFloat(Disc);
                   }
                    else if (DISCOUNT_PLAN == 'discount')
                    {
                     frontol.actions.showMessage("Скидка: "+Disc + "%");
                         discount = parseFloat(Disc);
                      }
                       else if (DISCOUNT_PLAN == 'combo')
                       {
                          var temp = Disc.split('#',2);
                         frontol.actions.showMessage("Бонусов: "+temp[0] + "; Скидка - "+temp[1] + "%");
                         bonus = parseFloat(temp[0]);
                         discount = parseFloat(temp[1]);
                          }


            return ;
        }
        catch(e){
            frontol.actions.showError(e);
            return null;
        }
     }
     else if(xhr.status === 404)
     {
          frontol.actions.showError("Карта " + card_code+" не найдена");
          return null;
     }
      else if(xhr.status === 503)
     {
          frontol.actions.showError("Проверьте параметры доступа и действие подписки");
          return null;
     }
     else
     {
        frontol.actions.showError("Ошибка получения данных с дисконтного сервиса");
        return;
     }


}
//служебная функция
function addDocDataToRequest(data)
{
    var doc_number = frontol.currentDocument.number;
    var doc_external_id =frontol.currentDocument.externalID;
    var doc_close_user = frontol.currentDocument.closeUser.name;
    var session = frontol.sessionNumber;
    var shop = frontol.shopNumber;
    var workplace = frontol.codeWorkplace;
     data+= "&doc_number="+doc_number;
     data+= "&doc_external_id="+doc_external_id;
     data+= "&doc_close_user=" + doc_close_user;
     data+= "&session=" + session;
     data+= "&shop=" + shop;
     data+= "&workplace=" + workplace;
     return data;
}


function addCardAccum(value)
{
    var xhr = new ActiveXObject("MSXML2.XMLHTTP");
    var salt = Math.random();

    var doc_number = frontol.currentDocument.number;
    var doc_external_id =frontol.currentDocument.externalID;
    var doc_close_user = frontol.currentDocument.closeUser.name;
    var session = frontol.sessionNumber;
    var shop = frontol.shopNumber;
    var workplace = frontol.codeWorkplace;

     xhr.open("POST", SERVER+"api/cards/add_accum/"+card_code+"_" + salt+"/", true);
     xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
     var data = "key=" + ACCESS_KEY;
     data+= "&value="+value;
     // информация о документе
     data = addDocDataToRequest(data);

     xhr.send(data);
     var Disc = 0;
     while(xhr.readyState != 4) {
        frontol.actions.wait("Идет запрос к дисконтному серверу", 1);
     }
     if(xhr.status === 200) {
        try{
            Disc = new Number(parseFloat(xhr.responseText));
            if (Disc == value)
            {
             return true;
            }    else
            {
             return false;
            }
        }
        catch(e){
            frontol.actions.showError(e);
            return false;
        }
     }
     else
     {
        frontol.actions.showError("Ошибка получения данных с дисконтного сервиса");
        return false;
     }
     return false;
}


function remCardBonus(val)
{
    var xhr = new ActiveXObject("MSXML2.XMLHTTP");
       var salt = Math.random();
     xhr.open("POST", SERVER+"api/cards/rem_bonus/"+card_code+"_" + salt+"/", true);
     xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
     var data = "key=" + ACCESS_KEY;
     data+= "&value="+val;
     // информация о документе
     data = addDocDataToRequest(data);
     xhr.send(data);
     var Disc = 0;
     while(xhr.readyState != 4){
        frontol.actions.wait("Идет запрос к дисконтному серверу", 1);
     }
     if(xhr.status === 200) {
        try{
            Disc = new Number(parseFloat(xhr.responseText));
            return Disc;
        }
        catch(e){
            frontol.actions.showError(e);
            return 0;
        }
     }
     else
     {
        frontol.actions.showError("Ошибка получения данных с дисконтного сервиса");
     }
}
